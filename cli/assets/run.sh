#!/bin/bash
# Hyperbranch Run Script
# Generated by Hyperbranch CLI

set -e

# Handle signals to propagate to the container
trap 'echo "Caught SIGINT in script"; exit 130' SIGINT SIGTERM

echo "Starting Docker Container..."
echo "  Image: $HB_IMAGE"
echo "  Command: $HB_CMD"

# Determine if we should use -it (Interactive TTY)
# We only use -it if both stdin (0) and stdout (1) are TTYs.
# This allows 'hb run' (piped) to work without -it, while manual './run.sh' gets -it.
DOCKER_FLAGS=""
if [ -t 0 ] && [ -t 1 ]; then
    DOCKER_FLAGS="-it"
fi

# Using 'exec' to replace the shell process with Docker, 
# ensuring signals go directly to Docker (though --init handles init process duties)

DOCKER_NAME_FLAG=""
if [ -n "$HB_NAME" ]; then
    DOCKER_NAME_FLAG="--name $HB_NAME"
fi

exec docker run \
  --rm \
  --init \
  $DOCKER_FLAGS \
  $DOCKER_NAME_FLAG \
  --cidfile "hb.cid" \
  -w "/app" \
  -u "$HB_USER" \
  $HB_ARGS \
  -v "$(pwd):/app" \
  "$HB_IMAGE" \
  $HB_CMD
