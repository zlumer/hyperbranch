---
id: 69y-koz-47x
status: todo
parent: null
dependencies: []
---
# Implement Secure Deno Server with Hono & WebSockets

**Goal**: Build a robust, secure Deno server exposing CLI functionality via REST and WebSockets, sharing core logic with the CLI.

## Architecture

- **Framework**: Hono (Standard-compliant, lightweight) via `jsr:@hono/hono`.
- **Service Pattern**: Functional modules with exported functions (no classes).
- **Communication**: 
  - REST API for control/management.
  - WebSockets for real-time log streaming.
- **Security**: 
  - **Authentication**: API Key via `X-API-Key` header.
  - **Configuration**: Key set via `HB_API_KEY`. If not set, generate one and **print to console** on startup.
  - **CORS**: Enabled for all origins (`*`).
- **Configuration**:
  - Port: Default `8000`, configurable via `PORT` env or `--port` flag.
- **Response Format**: Wrapped JSON
  ```json
  {
    "success": true,
    "data": { ... },
    "error": null
  }
  ```
- **Code Structure**: Shared `services/` directory for business logic (functional modules), used by both `commands/` (CLI) and `server/` (API).

## Steps

### 1. Setup & Dependencies
- [ ] Add `hono` (jsr) to `cli/deno.json`.
- [ ] Create directories: `cli/services`, `cli/server/middleware`, `cli/server/routes`.

### 2. Service Layer Extraction (Refactoring)
Refactor logic from `cli/commands/` into reusable functional service modules. **Ensure `Deno.exit()` is replaced by standard Error throwing.**

- [ ] **`cli/services/TaskService.ts`** (Functional Module)
  - `create(title, parentId?)`: Handle ID generation, file creation, git commit.
  - `list()`: Scan `.hyperbranch/tasks/`, parse frontmatter.
  - `get(id)`: Read and parse specific task file.
  - `update(id, updates)`: Modify frontmatter/content, handle file moves (status changes).
- [ ] **`cli/services/ExecutionService.ts`** (Functional Module)
  - `run(id, options)`: Prepare worktree, build Docker image, start container. Return `runId` / `containerId`.
  - `stop(id)`: Locate running container (via CID file), execute `docker stop`.
  - `getLogsPath(id, runIndex)`: Resolve path to `docker.log` (generated by `run.sh`).
  - `getStatus(id)`: Check if container is running.
- [ ] **`cli/services/GitService.ts`** (Functional Module)
  - Refactor `cli/utils/git.ts` into a service module, ensuring consistent error handling.
- [ ] **Refactor CLI Commands**
  - Update `create.ts`, `run.ts`, `stop.ts`, `logs.ts`, `ps.ts` to use the new service modules.
  - Ensure `logs.ts` reads `docker.log` (consistent with `run.sh`).

### 3. Server Implementation
- [ ] **Middleware**
  - `auth.ts`: Verify `X-API-Key`.
  - `response.ts`: Wrap responses in `{ success, data, error }`.
  - `errorHandler.ts`: Global error catching. Map standard errors (e.g. `Deno.errors.NotFound` -> 404) to HTTP status codes.
  - `cors.ts`: Enable CORS for all origins.
- [ ] **REST Routes**
  - `GET /tasks`: List tasks.
  - `POST /tasks`: Create task.
  - `GET /tasks/:id`: Get task details.
  - `POST /tasks/:id/run`: Start task execution. Body accepts `image`, `exec`, `env`, etc.
  - `POST /tasks/:id/stop`: Stop task execution.
- [ ] **WebSocket Routes**
  - `GET /ws/tasks/:id/logs`: Upgrade connection. Stream `docker.log` as interleaved JSON messages (`{ data: string }`).
- [ ] **Entrypoint**
  - `cli/server/main.ts`: Initialize app, generate/print API key, start server (`Deno.serve`).

### 4. CLI Integration
- [ ] Create `cli/commands/server.ts`: Wrapper to launch `cli/server/main.ts`.
- [ ] Update `cli/hb.ts`: Register `server` command.

### 5. Testing
- [ ] Create `cli/tests/server_test.ts`: Integration tests for API endpoints using `app.request()`.

  - `GET /tasks`: List tasks.
  - `POST /tasks`: Create task.
  - `GET /tasks/:id`: Get task details.
  - `POST /tasks/:id/run`: Start task execution.
  - `POST /tasks/:id/stop`: Stop task execution.
- [ ] **WebSocket Routes**
  - `GET /ws/tasks/:id/logs`: Upgrade connection. Stream `docker.log` using `tail -f` logic.
- [ ] **Entrypoint**
  - `cli/server/main.ts`: Initialize app, start server (`Deno.serve`).

### 4. CLI Integration
- [ ] Create `cli/commands/server.ts`: Wrapper to launch `cli/server/main.ts`.
- [ ] Update `cli/hb.ts`: Register `server` command.

### 5. Testing
- [ ] Create `cli/tests/server_test.ts`: Integration tests for API endpoints using `app.request()`.
